(function(){var e=this,r=function(e,r){var t=this;void 0===e&&(e={}),t.sound_resource=e,t.audioCtx=new(window.AudioContext||window.webkitAudioContext),t.soundThread={},t.uname="snd",t.ucnt=0,Object.keys(e).length>0&&t.load_urls(r)};r.prototype={stop:function(e){var r=this,t=[];for(var n in r.soundThread)r.soundThread[n].key==e&&t.push(r.soundThread[n].source);for(var o=0;o<t.length;o++)r.tech_stop(t[o])},tech_stop:function(e){let r=1,t=performance.now(),n=function(){let o=performance.now();r-=.01*(o-t),t=o,e.gaining_node.gain.value=r,r>0?requestAnimationFrame(n):e.stop()};requestAnimationFrame(n)},stop_by_pid:function(e){var r=this,t=[];for(var n in r.soundThread)n==e&&t.push(r.soundThread[n].source);for(var o=0;o<t.length;o++)r.tech_stop(t[o])},add_url:function(e,r,t){var n=this;"Array"===e.constructor.name?(t=r,e.forEach(e=>{n.sound_resource[e]=e}),n.load_urls(t)):(void 0===r&&(r=e),n.sound_resource[r]=e,n.load_urls(t))},load_urls:function(e){e||(e=()=>{});var r=this,t=[],n=0,o=[];for(var u in r.sound_resource)"string"==typeof r.sound_resource[u]&&t.push(u);if(t.length>0)for(var a=0;a<t.length;a++)r.audio_to_b64(t[a],(function(u,a,i,s){n++,a?(delete r.sound_resource[s],o.push({err:a,url:i,key:s})):r.sound_resource[s]={url:i,base64:u},t.length==n&&e(o.length?o:null)}));else e(null)},extract_all:function(e){var r=this,t=Object.keys(r.sound_resource).length,n=function(r){r&&--t<=0&&e()};for(var o in r.sound_resource)r.extract_sound(o,n)},grant_permission:function(){this.play()},play:function(e,r){var t=this;"interrupted"===t.audioCtx.state&&t.audioCtx.resume(),void 0===e&&(e="grant_key",this.permission=!0),t.extract_sound(e,(function(e){e.play&&t.permission&&e.play(r)}))},isLoaded:function(e){let r=this;return!!r.sound_resource[e]&&"Object"===r.sound_resource[e].constructor.name},isLoading:function(e){let r=this;return!!r.sound_resource[e]&&"Object"!==r.sound_resource[e].constructor.name},run:function(e,r){let t=this;this.permission||t.grant_permission(),t.isLoaded(e)?this.play(e,r):t.isLoading(e)||t.add_url(e,e,t=>{t&&t.filter(r=>r.url===e).length?r&&r.error&&r.error():this.play(e,r)})},audio_to_b64:function(e,t){var n=this,o=n.sound_resource[e],u=new XMLHttpRequest;u.open("GET",o,!0),u.responseType="arraybuffer",u.onerror=function(){t(null,"network fail",o,e)},u.onload=function(){200==u.status?n.audioCtx.decodeAudioData(u.response,(function(u){n.audioCtx.createBufferSource().buffer=u;var a=r.createWaveFileData(u),i=btoa(r.uint8ToString(a));t(i,null,o,e)}),(function(r){t(null,r,o,e)})):t(null,u.statusText,o,e)},u.send()},extract_sound:function(e,t){var n=this,o=!1;if(!n.isLoaded(e)&&!n.isLoading(e)&&"grant_key"===e){n.sound_resource[e]={};for(var u=3e-5*n.audioCtx.sampleRate,a=n.audioCtx.createBuffer(2,u,n.audioCtx.sampleRate),i=0;i<2;i++)for(var s=a.getChannelData(i),d=0;d<u;d++)s[d]=2*Math.random()-1;n.sound_resource[e].buffer=a}n.isLoaded(e)&&(n.sound_resource[e].play||(n.sound_resource[e].play=function(r){n.ucnt++;var t=n.uname+"-"+n.ucnt,o=n.audioCtx.createBufferSource();n.soundThread[t]={key:e,source:o};var u={resource_info:n.soundThread[t],pid:t,source:o};o.buffer=this.buffer;var a=this.audioCtx.createGain();o.connect(a),a.connect(this.audioCtx.destination),a.gain.value="grant_key"===e?0:1,o.gaining_node=a;let i=this.audioCtx.currentTime,s=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},d=()=>{if(n.soundThread[t]){let e=this.audioCtx.currentTime-i,a=!0;if(r&&r.playtime&&r.playtime/1e3<=e&&(a=!1),e>0&&r&&r.start&&(r.start(u),delete r.start),r&&r.progress&&!r.start){let t=e/o.buffer.duration;t>1&&(t=1),r.progress(u,t)}a?s(d):n.stop_by_pid(t)}};o.onended=function(){r&&r.progress&&r.progress(u,1),delete n.soundThread[t],r&&r.end&&r.end(u)},o.start(),d()},n.sound_resource[e].audioCtx=n.audioCtx,n.sound_resource[e].buffer||(o=!0,n.audioCtx.decodeAudioData(r._base64ToArrayBuffer(n.sound_resource[e].base64),(function(r){n.sound_resource[e].buffer=r,delete n.sound_resource[e].base64,t(n.sound_resource[e])}),(function(r){delete n.sound_resource[e]}))))),o||t(n.sound_resource[e])}},e.AudioManager=r,e.AudioManager.createWaveFileData=function(e){var t=e.length,n=e.numberOfChannels,o=e.sampleRate,u=o*n*16/8,a=16*n/8,i=t*n*2,s=new Uint8Array(44+i),d=i,c=28+(8+d);return r.writeString("RIFF",s,0),r.writeInt32(c,s,4),r.writeString("WAVE",s,8),r.writeString("fmt ",s,12),r.writeInt32(16,s,16),r.writeInt16(1,s,20),r.writeInt16(n,s,22),r.writeInt32(o,s,24),r.writeInt32(u,s,28),r.writeInt16(a,s,32),r.writeInt32(16,s,34),r.writeString("data",s,36),r.writeInt32(d,s,40),r.writeAudioBuffer(e,s,44),s},e.AudioManager.writeString=function(e,r,t){for(var n=0;n<e.length;++n)r[t+n]=e.charCodeAt(n)},e.AudioManager.writeInt16=function(e,r,t){var n=255&(e=Math.floor(e)),o=e>>8&255;r[t+0]=n,r[t+1]=o},e.AudioManager.writeInt32=function(e,r,t){var n=255&(e=Math.floor(e)),o=e>>8&255,u=e>>16&255,a=e>>24&255;r[t+0]=n,r[t+1]=o,r[t+2]=u,r[t+3]=a},e.AudioManager.writeAudioBuffer=function(e,t,n){for(var o=e.length,u=e.numberOfChannels,a=0;a<o;++a)for(var i=0;i<u;++i){var s=32768*e.getChannelData(i)[a];s<-32768&&(s=-32768),s>32767&&(s=32767),r.writeInt16(s,t,n),n+=2}},e.AudioManager.uint8ToString=function(e){var r,t,n="";for(r=0,t=e.length;r<t;r+=1)n+=String.fromCharCode(e[r]);return n},e.AudioManager._base64ToArrayBuffer=function(e){for(var r=window.atob(e),t=r.length,n=new Uint8Array(t),o=0;o<t;o++)n[o]=r.charCodeAt(o);return n.buffer}}).call(this);